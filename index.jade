doctype html5
html(lang='en')
    head
        meta(charset='utf-8')
        meta(http-equiv='X-UA-Compatible', content='IE=edge')
        meta(name='viewport', content='width=device-width, initial-scale=1')
        title Ballade à Metz
        link(href='css/bootstrap.min.css', rel='stylesheet')
        link(href='css/ballade-a-metz.css', rel='stylesheet')
        //if lt IE 9
            script(src='https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js')
            script(src='https://oss.maxcdn.com/respond/1.4.2/respond.min.js')

    body
        //-oldhopital saulcy
        .background.pompidou(data-audio="audio/mcour.mp3", data-image='img/pompidou.jpg')
        .background.cathedrale(data-audio="audio/Orgue Cathédrale.mp3", data-image='img/cathedrale.jpg')
        .background.moselle(data-audio="audio/blida.mp3", data-image='img/moselle.jpg')
        .background.porte(data-audio="audio/pole.mp3", data-image='img/porte-des-allemands.jpg')
        .background.temple(data-audio="audio/pref.mp3", data-image='img/temple.jpg')
        .background.plandeau(data-audio="audio/cime.mp3", data-image='img/plan-d-eau.jpg')

        .container
            .content.ll.keep
                h1 Ballade à Metz

            .spacer.keep.remove
            .content.keep.remove
                p.text-center Chargement en cours...
                .progress
                    #progress.progress-bar.progress-bar-info(role="progressbar" aria-valuemin="0" aria-valuemax="100")

            .spacer
            .content
                p Allumez le son, et faites défiler la page&nbsp;!

            .spacer
            .content.lll
                p Ballade à Metz a pour but d'ajouter une dimension musicale à Metz, comme si l'on écoutait la ville.

            .spacer
            .content.ll
                p Ballade à Metz est une application mobile qui utilise la géolocalisation pour jouer la musique d'un endroit.

            .spacer
            .content.l
                p Chaque lieu important est associé à un thème musical dont le volume dépend de la proximité du lieu.

            .spacer
            .content
                p À ces thèmes s'ajoutent des petites mélodies qui correspondent à divers éléments urbains&nbsp;: une boîte postale, un arrêt de bus, un arbre centenaire...

            .spacer
            .content.r
                p Ballade à Metz habille de musique vos déplacements dans la ville  pour mettre en valeur son patrimoine...

            .spacer
            .content.rr
                p ...et faire redécouvrir le plaisir de s'y promener au gré d'une symphonie à chaque fois différente.

            .spacer
            .content.rrr
                p Ballade à Metz est le projet proposé par l'équipe des 
                    a(href='http://nicepenguins.tumblr.com/', target='blank') Nice Penguins 
                    |(
                    a(href='https://twitter.com/MCD_Artagnan') Anthony Guérin
                    |, Baptiste Lesquoy, 
                    a(href='http://quentin.bonnard.eu', target='blank') Quentin Bonnard
                    |, Jonhathan Lamont,
                    a(href='https://twitter.com/Striwx') Yvan Corsiglia
                    |)

            .spacer
            .content.rr
                p à l'occasion du 
                    a(href='http://grandestnumerique.org/retour-hackathon.php' target='_blank') Hackathon GEN Lorraine

            .spacer
            .content.r
                p Il a remporté le Prix coup de cœur de Metz Métropole et la Mairie de Metz :)

            .spacer
            .content
                p Le concept de la Ballade à Metz peut se décliner dans plusieurs contextes.

            .spacer
            .content.l
                p L'application la plus évidente est dans le domaine du tourisme, pour découvrir de façon ludique et poétique la ville de Metz.

            .spacer
            .content.ll
                p Le concept peut gagner un aspect social si l'on met en place un système permettant de créer et partager son propre habillage musical.

            .spacer
            .content.lll
                p Aussi, puisque l'application est exclusivement sonore, elle serait une candidate à une déclinaison adaptée aux non-voyants et mal-voyants.

            .spacer
            .content.ll
                p Enfin, la ballade peut évidemment habiller d'autres villes, d'autres lieux, ou d'autres événements.

            .spacer
            .content.l
                p La musique pourrait venir des différents moyens de transport en commun...

            .spacer
            .content
                p On pourrait entendre des citations ou des poêmes associés à des lieux précis... Et cætera.

            .spacer
            .content.r
                p Abonnez-vous à notre newsletter pour rester au courant&nbsp;!
                p &nbsp;

                form(action='https://docs.google.com/forms/d/1kVh7qiYzPOEwx-3m3Ub14tiN4H8NtFD5eCQPH4rpzCU/formResponse?embedded=true', method='POST', target='_blank', onsubmit='', role='form')
                    .form-group
                        p
                            label Nom
                        p
                            input(type='text', name='entry.1609953104', value='', aria-label='Nom', aria-required='true', required='')
                    .form-group
                        p
                            label Adresse email
                        p
                            input.from-control(type='email', name='entry.1423520718', value='', aria-label='Email', aria-required='true',required='')
                    .form-group
                        p
                            button.btn.btn-default(type='submit', name='submit', value='Envoyer') Envoyer
                p Musiques: Anthony Guérin et Yvan Corsiglia
                p Photos: Sébastien Perségol
                p Design: Quentin Bonnard

            .spacer

        script(src='js/jquery.min.js')
        script(src='js/bootstrap.min.js')
        script.
            $(document).ready(function() {
                $('.content:not(.keep),.spacer:not(.keep)').each(function(e){$(this).hide(0);});

                var backgrounds = document.getElementsByClassName('background');
                var bgCount = backgrounds.length;

                var audioWeight=1;
                var imageWeight=1;
                var toLoad = bgCount*(imageWeight+audioWeight);
                var loaded = 0;
                var progressBar = document.getElementById('progress');
                function updateProgressBar(increment) {
                    loaded += increment;
                    progressBar.style.width = (100*loaded/toLoad)+"%";
                    if (loaded >= toLoad) {
                        $('.content,.spacer').each(function(e){$(this).show();});
                        $('.remove').each(function(e){$(this).hide();});
                        $(document).scroll(setEnvironment);
                        setEnvironment();
                    }
                };

                for (var i = 0; i < bgCount; i++) {
                    audio = document.createElement('audio');
                    audio.src = backgrounds[i].getAttribute('data-audio');
                    audio.volume = 0;
                    audio.loop=true;
                    //audio.type="audio/mp3"
                    audio.play()

                    function audioLoaded() {
                        if (typeof this.alreadyLoaded === "undefined") {
                            this.alreadyLoaded = true;
                            updateProgressBar(audioWeight);
                        }
                    }
                    audio.addEventListener('canplaythrough', audioLoaded);
                    backgrounds[i].appendChild(audio);

                    img = document.createElement('img');
                    img.src = backgrounds[i].getAttribute('data-image');
                    
                    img.addEventListener('load', function () {updateProgressBar(imageWeight);});
                    img.style.display='none';
                    backgrounds[i].appendChild(img);
                };

                function setEnvironment() {
                    var maxScroll = document.body.scrollHeight-document.body.clientHeight;
                    var scrollRatio = document.body.scrollTop / maxScroll;
                    for (var i = 0; i < bgCount; i++) {
                        var x = scrollRatio*(bgCount-1);
                        var density = -1*(x-(i+1))*(x-(i-1));
                        density = Math.max(0,density);
                        density = Math.min(1,density);
                        backgrounds[i].style.opacity = density;
                        backgrounds[i].getElementsByTagName('audio')[0].volume = density;
                    }
                };
            });

